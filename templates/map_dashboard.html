{% extends "base1.html" %} {% block head %}
<style>
  #earth-view-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    display: none;
    background: #000;
  }
  #earth-view-map {
    width: 100%;
    height: 100%;
  }
  .earth-overlay-controls {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.95);
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    max-width: 300px;
    display: none !important;
  }
  .earth-controls-bottom {
    position: absolute;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .earth-control-btn {
    background: rgba(255, 255, 255, 0.95);
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
  }
  .earth-control-btn:hover {
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid px-4 py-4">
  <div class="hero-section text-center mb-4">
    <h1 class="display-5 fw-bold gradient-text">Interactive Detection Map</h1>
    <p class="lead text-secondary">
      Real-time visualization powered by Google Maps Platform with AI-Enhanced
      Features
    </p>
  </div>

  <div class="row g-4">
    <!-- Left Panel: Controls & Stats -->
    <div class="col-lg-3">
      <!-- Stats Card -->
      <div class="glass-card mb-4">
        <div class="card-header-custom mb-3">
          <h5><i class="fas fa-chart-pie me-2"></i>Overview</h5>
        </div>
        <div class="row g-3 text-center">
          <div class="col-6">
            <div class="p-3 rounded bg-white bg-opacity-10">
              <h3 class="fw-bold text-warning mb-0" id="pothole-count">0</h3>
              <small class="text-muted text-uppercase">Potholes</small>
            </div>
          </div>
          <div class="col-6">
            <div class="p-3 rounded bg-white bg-opacity-10">
              <h3 class="fw-bold text-danger mb-0" id="accident-count">0</h3>
              <small class="text-muted text-uppercase">Accidents</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="glass-card mb-4">
        <div class="card-header-custom mb-3">
          <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
        </div>
        <div class="d-grid gap-2">
          <button
            class="btn btn-outline-primary custom-btn"
            onclick="showCurrentLocation()"
          >
            <i class="fas fa-crosshairs me-2"></i>My Location
          </button>
          <button
            class="btn btn-outline-info custom-btn"
            onclick="showAllDetections()"
          >
            <i class="fas fa-layer-group me-2"></i>Show All
          </button>
          <button
            class="btn btn-outline-success custom-btn"
            onclick="findNearbyHospitals()"
          >
            <i class="fas fa-hospital me-2"></i>Nearby Hospitals
          </button>
          <button
            class="btn btn-warning custom-btn text-white"
            onclick="generateDemoData()"
          >
            <i class="fas fa-magic me-2"></i>Generate Demo Data
          </button>
        </div>
      </div>

      <!-- Search -->
      <div class="glass-card">
        <div class="card-header-custom mb-3">
          <h5><i class="fas fa-search me-2"></i>Search</h5>
        </div>
        <div class="input-group mb-3">
          <input
            type="text"
            id="addressSearch"
            class="form-control"
            placeholder="Enter location..."
          />
          <button class="btn btn-primary" onclick="searchAddress()">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Center Panel: Map -->
    <div class="col-lg-9">
      <div
        class="glass-card p-0 h-100 position-relative overflow-hidden"
        style="min-height: 600px"
      >
        <!-- Map Controls Overlay -->
        <div class="map-controls-overlay d-flex flex-column gap-2">
          <!-- View Types -->
          <div
            class="btn-group shadow-sm bg-white bg-opacity-10 backdrop-blur rounded-pill p-1"
          >
            <button
              class="btn btn-sm btn-light rounded-pill active"
              id="btn-roadmap"
              onclick="switchMapType('roadmap')"
            >
              Road
            </button>
            <button
              class="btn btn-sm btn-light rounded-pill"
              id="btn-satellite"
              onclick="switchMapType('satellite')"
            >
              Sat
            </button>
            <button
              class="btn btn-sm btn-light rounded-pill"
              id="btn-terrain"
              onclick="switchMapType('terrain')"
            >
              Terrain
            </button>
            <button
              class="btn btn-sm btn-light rounded-pill"
              id="btn-hybrid"
              onclick="switchMapType('hybrid')"
            >
              Hybrid
            </button>
          </div>

          <!-- Layer Controls -->
          <div class="d-flex gap-2">
            <button
              class="btn btn-sm btn-light shadow-sm rounded-pill"
              id="btn-traffic"
              onclick="toggleTrafficLayer()"
            >
              <i class="fas fa-traffic-light me-1"></i>Traffic
            </button>
            <button
              class="btn btn-sm btn-light shadow-sm rounded-pill"
              id="btn-3d"
              onclick="toggle3D()"
            >
              <i class="fas fa-cube me-1"></i>3D
            </button>
            <button
              class="btn btn-sm btn-light shadow-sm rounded-pill"
              id="btn-globe"
              onclick="switchToGoogleEarth()"
            >
              <i class="fas fa-globe-americas me-1"></i>Google Earth
            </button>
            <button
              class="btn btn-sm btn-light shadow-sm rounded-pill"
              id="heatmap-toggle"
              onclick="toggleTerrainHeatmap()"
            >
              <i class="fas fa-fire me-1"></i>Risk Map
            </button>
            <button
              class="btn btn-sm btn-light shadow-sm rounded-pill"
              id="gee-analyze"
              onclick="analyzeTerrainGEE()"
            >
              <i class="fas fa-mountain me-1"></i>GEE Analysis
            </button>
            <div
              class="btn-group shadow-sm bg-white bg-opacity-10 backdrop-blur rounded-pill ms-2"
              id="rotate-controls"
              style="display: none"
            >
              <button
                class="btn btn-sm btn-light rounded-pill"
                onclick="rotateMap(-45)"
              >
                <i class="fas fa-undo"></i>
              </button>
              <button
                class="btn btn-sm btn-light rounded-pill"
                onclick="rotateMap(45)"
              >
                <i class="fas fa-redo"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Report Button Overlay -->
        <div class="report-btn-overlay">
          <button
            class="btn btn-danger shadow-lg rounded-pill px-4 py-2"
            id="btn-report-mode"
            onclick="toggleReportMode()"
          >
            <i class="fas fa-exclamation-triangle me-2"></i>Report Issue
          </button>
        </div>

        <!-- Map Container -->
        <div id="map" class="h-100 w-100">
          <div
            class="d-flex flex-column align-items-center justify-content-center h-100 text-muted"
          >
            <div class="spinner-border mb-3" role="status"></div>
            <p>Loading Google Maps...</p>
          </div>
        </div>

        <!-- Embedded Google Earth View -->
        <div id="earth-view-container">
          <div id="earth-view-map"></div>

          <!-- Detection Controls Overlay for Earth View -->
          <div
            class="earth-overlay-controls"
            id="earth-detection-panel"
            style="display: none"
          >
            <h6 class="fw-bold mb-3">
              <i class="fas fa-layer-group me-2 text-primary"></i>Active
              Detections
            </h6>
            <div id="earth-detection-list" class="small">
              <!-- Will be populated dynamically -->
            </div>
            <button
              class="btn btn-sm btn-primary w-100 mt-3"
              onclick="syncDetectionsToEarth()"
            >
              <i class="fas fa-sync me-1"></i>Refresh Detections
            </button>
          </div>

          <!-- Earth View Control Buttons -->
          <div
            class="earth-controls-bottom"
            id="earth-controls"
            style="display: none"
          >
            <button class="earth-control-btn" onclick="zoomToGlobeView()">
              <i class="fas fa-globe me-2"></i>Globe View
            </button>
            <button class="earth-control-btn" onclick="rotateEarthLeft()">
              <i class="fas fa-undo me-2"></i>Rotate Left
            </button>
            <button class="earth-control-btn" onclick="rotateEarthRight()">
              <i class="fas fa-redo me-2"></i>Rotate Right
            </button>
            <button class="earth-control-btn" onclick="tiltEarthView()">
              <i class="fas fa-angle-double-down me-2"></i>Adjust Tilt
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Detections Table -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="glass-card">
        <div class="card-header-custom mb-3">
          <h5><i class="fas fa-list me-2"></i>Recent Detections</h5>
        </div>
        <div class="table-responsive">
          <table class="table table-hover custom-table align-middle">
            <thead>
              <tr>
                <th>Type</th>
                <th>Location</th>
                <th>Time</th>
                <th>Confidence</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="detections-table">
              <tr>
                <td colspan="5" class="text-center py-4">
                  Loading detections...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card border-0">
      <div class="modal-header border-0">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-circle text-danger me-2"></i>Report
          Pothole
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="report-form">
          <div class="mb-3">
            <label class="form-label text-muted small fw-bold">LOCATION</label>
            <input
              type="text"
              id="report-location"
              class="form-control"
              readonly
            />
          </div>
          <div class="mb-3">
            <label class="form-label text-muted small fw-bold"
              >DESCRIPTION</label
            >
            <textarea
              id="report-description"
              class="form-control"
              rows="3"
              placeholder="Describe the condition..."
            ></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label text-muted small fw-bold">SEVERITY</label>
            <select id="report-severity" class="form-select custom-select">
              <option value="low">Low - Minor damage</option>
              <option value="medium" selected>
                Medium - Noticeable damage
              </option>
              <option value="high">High - Severe damage</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0">
        <button
          type="button"
          class="btn btn-outline-light"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button type="button" class="btn btn-danger" onclick="submitReport()">
          Submit Report
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .map-controls-overlay {
    position: absolute;
    top: 1rem;
    left: 1rem;
    z-index: 10;
  }

  .report-btn-overlay {
    position: absolute;
    bottom: 2rem;
    right: 1rem;
    z-index: 10;
  }

  .backdrop-blur {
    backdrop-filter: blur(10px);
  }
</style>

<script>
  const DEFAULT_LAT = parseFloat("{{ default_lat }}");
  const DEFAULT_LNG = parseFloat("{{ default_lng }}");
  const GOOGLE_MAPS_API_KEY = "{{ api_key }}";
  let googleMap;
  let markers = [];
  let heatmapLayer = null;
  let trafficLayer = null;
  let is3D = false;
  let reportMode = false;
  let reportMarker = null;
  let reportLat = null;
  let reportLng = null;
  let reportModal = null;
  let isGlobeMode = false;
  let mapInitialized = false;
  // cesiumViewer is declared in theme-manager.js globally

  // Error handler for Google Maps API loading failure
  function handleMapError() {
    const mapContainer = document.getElementById("map");
    if (mapContainer) {
      mapContainer.innerHTML = `
        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-center p-4">
          <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
          <h5 class="text-white mb-2">Map Loading Failed</h5>
          <p class="text-muted small mb-3">
            Google Maps API could not be loaded. Please ensure:<br>
            1. Your API key is valid<br>
            2. Maps JavaScript API is enabled in Google Cloud Console<br>
            3. Places API is enabled (for nearby hospitals)<br>
            4. Billing is enabled for your project
          </p>
          <a href="https://console.cloud.google.com/apis/library/maps-backend.googleapis.com" 
             target="_blank" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-external-link-alt me-1"></i>Enable Maps API
          </a>
        </div>
      `;
    }
    console.error(
      "Google Maps API failed to load. Please check your API key and enabled APIs."
    );
  }

  // Check if Google Maps API is available
  function checkGoogleMapsAPI() {
    if (typeof google === "undefined" || typeof google.maps === "undefined") {
      handleMapError();
      return false;
    }
    return true;
  }

  function initializeMap() {
    // Check if Google Maps API is available
    if (!checkGoogleMapsAPI()) {
      return;
    }

    try {
      const mapContainer = document.getElementById("map");
      // Don't clear if we are just re-initializing Google Maps
      if (!isGlobeMode) {
        mapContainer.innerHTML = "";

        googleMap = new google.maps.Map(document.getElementById("map"), {
          center: { lat: DEFAULT_LAT, lng: DEFAULT_LNG },
          zoom: 13,
          mapId: "d3c6c3e3f8a3c3c3", // Enable Vector Map features including 3D
          mapTypeId: "roadmap",
          heading: 0,
          tilt: 0,
          rotateControl: true,
          styles: getMapStyles(),
          mapTypeControl: false,
          fullscreenControl: true,
          streetViewControl: true,
          zoomControl: true,
        });

        trafficLayer = new google.maps.TrafficLayer();
        googleMap.addListener("click", handleMapClick);

        // Re-add markers if they exist
        if (markers.length > 0) {
          loadAllDetections();
        }
      }

      reportModal = new bootstrap.Modal(document.getElementById("reportModal"));

      if (!isGlobeMode) {
        loadAllDetections();
        loadTerrainRiskData();
      }

      mapInitialized = true;
      console.log("✓ Google Maps initialized successfully");
    } catch (error) {
      console.error("Error initializing map:", error);
      handleMapError();
    }
  }

  function getMapStyles() {
    // Dark mode styles for Google Maps
    return [
      { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
      {
        featureType: "administrative.locality",
        elementType: "labels.text.fill",
        stylers: [{ color: "#d59563" }],
      },
      {
        featureType: "poi",
        elementType: "labels.text.fill",
        stylers: [{ color: "#d59563" }],
      },
      {
        featureType: "poi.park",
        elementType: "geometry",
        stylers: [{ color: "#263c3f" }],
      },
      {
        featureType: "poi.park",
        elementType: "labels.text.fill",
        stylers: [{ color: "#6b9a76" }],
      },
      {
        featureType: "road",
        elementType: "geometry",
        stylers: [{ color: "#38414e" }],
      },
      {
        featureType: "road",
        elementType: "geometry.stroke",
        stylers: [{ color: "#212a37" }],
      },
      {
        featureType: "road",
        elementType: "labels.text.fill",
        stylers: [{ color: "#9ca5b3" }],
      },
      {
        featureType: "road.highway",
        elementType: "geometry",
        stylers: [{ color: "#746855" }],
      },
      {
        featureType: "road.highway",
        elementType: "geometry.stroke",
        stylers: [{ color: "#1f2835" }],
      },
      {
        featureType: "road.highway",
        elementType: "labels.text.fill",
        stylers: [{ color: "#f3d19c" }],
      },
      {
        featureType: "transit",
        elementType: "geometry",
        stylers: [{ color: "#2f3948" }],
      },
      {
        featureType: "transit.station",
        elementType: "labels.text.fill",
        stylers: [{ color: "#d59563" }],
      },
      {
        featureType: "water",
        elementType: "geometry",
        stylers: [{ color: "#17263c" }],
      },
      {
        featureType: "water",
        elementType: "labels.text.fill",
        stylers: [{ color: "#515c6d" }],
      },
      {
        featureType: "water",
        elementType: "labels.text.stroke",
        stylers: [{ color: "#17263c" }],
      },
    ];
  }

  function switchMapType(type) {
    if (!googleMap) return;
    googleMap.setMapTypeId(type);

    document
      .querySelectorAll(".btn-group .btn")
      .forEach((btn) => btn.classList.remove("active"));
    document.getElementById(`btn-${type}`).classList.add("active");
  }

  function toggleTrafficLayer() {
    if (!trafficLayer) return;
    const btn = document.getElementById("btn-traffic");

    if (trafficLayer.getMap()) {
      trafficLayer.setMap(null);
      btn.classList.remove("btn-success", "text-white");
      btn.classList.add("btn-light");
    } else {
      trafficLayer.setMap(googleMap);
      btn.classList.remove("btn-light");
      btn.classList.add("btn-success", "text-white");
    }
  }

  function toggle3D() {
    if (isGlobeMode) {
      // In Globe mode, toggle between 2D and 3D view
      if (window.MapUtils && window.MapUtils.toggleViewMode) {
        window.MapUtils.toggleViewMode();
        is3D = !is3D;
        update3DButtonState();
      }
      return;
    }

    if (!googleMap) return;
    is3D = !is3D;
    update3DButtonState();

    const rotateControls = document.getElementById("rotate-controls");
    if (is3D) {
      googleMap.setTilt(45);
      googleMap.setHeading(0);
      rotateControls.style.display = "inline-flex";
    } else {
      googleMap.setTilt(0);
      googleMap.setHeading(0);
      rotateControls.style.display = "none";
    }
  }

  function update3DButtonState() {
    const btn = document.getElementById("btn-3d");
    if (is3D) {
      btn.classList.remove("btn-light");
      btn.classList.add("btn-success", "text-white");
    } else {
      btn.classList.remove("btn-success", "text-white");
      btn.classList.add("btn-light");
    }
  }

  function rotateMap(degrees) {
    if (!googleMap || isGlobeMode) return;
    const currentHeading = googleMap.getHeading() || 0;
    googleMap.setHeading(currentHeading + degrees);
  }

  // Toggle between Google Maps and TRUE 3D GLOBE Earth view
  let isEarthViewActive = false;
  let earthMap = null;
  let earthMarkers = [];
  let currentTilt = 45;

  function switchToGoogleEarth() {
    const btn = document.getElementById("btn-globe");
    const mapContainer = document.getElementById("map");
    const earthContainer = document.getElementById("earth-view-container");
    const earthPanel = document.getElementById("earth-detection-panel");
    const earthControls = document.getElementById("earth-controls");

    isEarthViewActive = !isEarthViewActive;

    if (isEarthViewActive) {
      // Switch to TRUE GLOBE Earth view
      btn.innerHTML =
        '<i class="fas fa-spinner fa-spin me-1"></i>Loading Globe...';
      btn.disabled = true;

      const lat = googleMap ? googleMap.getCenter().lat() : DEFAULT_LAT;
      const lng = googleMap ? googleMap.getCenter().lng() : DEFAULT_LNG;

      // Show Earth view, hide map
      mapContainer.style.display = "none";
      earthContainer.style.display = "block";
      // earthPanel.style.display = "block";  // Disabled - don't show modal
      earthControls.style.display = "flex";

      // Initialize TRUE 3D GLOBE Earth Map
      if (!earthMap) {
        earthMap = new google.maps.Map(
          document.getElementById("earth-view-map"),
          {
            center: { lat, lng },
            zoom: 3, // Start zoomed out to see Earth as a globe
            mapId: "d3c6c3e3f8a3c3c3",
            mapTypeId: "satellite",
            tilt: 45,
            heading: 0,
            rotateControl: true,
            fullscreenControl: true,
            mapTypeControl: false,
            streetViewControl: false,
            zoomControl: true,
            gestureHandling: "greedy",
            styles: [
              {
                featureType: "all",
                elementType: "labels",
                stylers: [{ visibility: "on" }],
              },
            ],
          }
        );

        // Enable continuous rotation for globe effect
        let autoRotate = null;
        earthMap.addListener("idle", () => {
          if (autoRotate) clearInterval(autoRotate);
        });
      } else {
        earthMap.setCenter({ lat, lng });
        earthMap.setZoom(3);
        earthMap.setTilt(45);
      }

      // Copy all markers to earth view
      setTimeout(() => {
        copyMarkersToEarthView();
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-map me-1"></i>Back to Map';
        btn.classList.add("btn-success", "text-white");
        btn.classList.remove("btn-light");
        showNotification(
          "Switched to 3D Globe Earth view - Use controls to explore!",
          "success"
        );
        // syncDetectionsToEarth();  // Disabled - don't show modal
      }, 1500);
    } else {
      // Switch back to Map view
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
      btn.disabled = true;

      mapContainer.style.display = "block";
      earthContainer.style.display = "none";
      earthPanel.style.display = "none";
      earthControls.style.display = "none";

      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML =
          '<i class="fas fa-globe-americas me-1"></i>Google Earth';
        btn.classList.remove("btn-success", "text-white");
        btn.classList.add("btn-light");
        showNotification("Switched to Map view", "info");
      }, 500);
    }
  }

  // Zoom out to full globe view
  function zoomToGlobeView() {
    if (!earthMap) return;
    earthMap.setZoom(2);
    earthMap.setTilt(45);
    showNotification("Zoomed to full globe view", "info");
  }

  // Rotate Earth left
  function rotateEarthLeft() {
    if (!earthMap) return;
    const currentHeading = earthMap.getHeading() || 0;
    earthMap.setHeading(currentHeading - 30);
  }

  // Rotate Earth right
  function rotateEarthRight() {
    if (!earthMap) return;
    const currentHeading = earthMap.getHeading() || 0;
    earthMap.setHeading(currentHeading + 30);
  }

  // Toggle tilt angle
  function tiltEarthView() {
    if (!earthMap) return;
    currentTilt = currentTilt === 45 ? 67.5 : 45;
    earthMap.setTilt(currentTilt);
    showNotification(`Tilt adjusted to ${currentTilt}°`, "info");
  }

  // Copy all detection markers to Earth view
  function copyMarkersToEarthView() {
    // Clear existing earth markers
    earthMarkers.forEach((m) => m.setMap(null));
    earthMarkers = [];

    // Copy markers from main map to earth map
    markers.forEach((marker) => {
      const isPothole = marker.detectionType === "pothole";
      const color = isPothole ? "#f59e0b" : "#ef4444";

      const earthMarker = new google.maps.Marker({
        position: marker.getPosition(),
        map: earthMap,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: color,
          fillOpacity: 0.9,
          strokeColor: "white",
          strokeWeight: 3,
        },
        title: marker.getTitle(),
      });

      // Copy info window
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="padding:8px;">
            <h6 class="mb-1 fw-bold">${marker.getTitle()}</h6>
            <small class="text-muted">Click to view details</small>
          </div>
        `,
      });

      earthMarker.addListener("click", () =>
        infoWindow.open(earthMap, earthMarker)
      );
      earthMarkers.push(earthMarker);
    });
  }

  // Sync detection markers to Earth view overlay panel
  function syncDetectionsToEarth() {
    const listContainer = document.getElementById("earth-detection-list");
    if (!listContainer) return;

    // Count detections from the markers array
    let potholeCount = 0;
    let accidentCount = 0;
    let humpCount = 0;

    markers.forEach((marker) => {
      const type = marker.detectionType || "";
      if (type === "pothole") potholeCount++;
      else if (type === "accident") accidentCount++;
      else if (type === "hump") humpCount++;
    });

    let html = "";
    let totalDetections = potholeCount + accidentCount + humpCount;

    // Add potholes
    if (potholeCount > 0) {
      html += `<div class="mb-2">
        <strong class="text-warning">
          <i class="fas fa-exclamation-triangle"></i> Potholes (${potholeCount})
        </strong>
      </div>`;
    }

    // Add accidents
    if (accidentCount > 0) {
      html += `<div class="mb-2">
        <strong class="text-danger">
          <i class="fas fa-car-crash"></i> Accidents (${accidentCount})
        </strong>
      </div>`;
    }

    // Add humps if available
    if (humpCount > 0) {
      html += `<div class="mb-2">
        <strong class="text-info">
          <i class="fas fa-road"></i> Speed Humps (${humpCount})
        </strong>
      </div>`;
    }

    if (totalDetections === 0) {
      html = '<p class="text-muted small mb-0">No detections to display</p>';
    } else {
      html += `<div class="mt-3 pt-3 border-top">
        <strong>Total: ${totalDetections} detections</strong>
      </div>`;
    }

    listContainer.innerHTML = html;
  }

  function toggleReportMode() {
    reportMode = !reportMode;
    const btn = document.getElementById("btn-report-mode");

    if (reportMode) {
      btn.innerHTML = '<i class="fas fa-times me-2"></i>Cancel Reporting';
      btn.classList.remove("btn-danger");
      btn.classList.add("btn-secondary");
      googleMap.setOptions({ draggableCursor: "crosshair" });
      showNotification("Click on map to mark pothole location", "info");
    } else {
      btn.innerHTML =
        '<i class="fas fa-exclamation-triangle me-2"></i>Report Issue';
      btn.classList.remove("btn-secondary");
      btn.classList.add("btn-danger");
      googleMap.setOptions({ draggableCursor: null });
      if (reportMarker) {
        reportMarker.setMap(null);
        reportMarker = null;
      }
    }
  }

  function handleMapClick(e) {
    if (!reportMode) return;

    reportLat = e.latLng.lat();
    reportLng = e.latLng.lng();

    if (reportMarker) reportMarker.setMap(null);

    reportMarker = new google.maps.Marker({
      position: e.latLng,
      map: googleMap,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 10,
        fillColor: "#ef4444",
        fillOpacity: 1,
        strokeColor: "white",
        strokeWeight: 3,
      },
      animation: google.maps.Animation.DROP,
    });

    // Reverse geocode
    fetch("/api/reverse_geocode", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ lat: reportLat, lng: reportLng }),
    })
      .then((res) => res.json())
      .then((data) => {
        document.getElementById("report-location").value =
          data.address || `${reportLat.toFixed(6)}, ${reportLng.toFixed(6)}`;
      })
      .catch(() => {
        document.getElementById("report-location").value = `${reportLat.toFixed(
          6
        )}, ${reportLng.toFixed(6)}`;
      });

    reportModal.show();
  }

  async function submitReport() {
    const description = document.getElementById("report-description").value;
    const severity = document.getElementById("report-severity").value;

    if (!description.trim()) {
      showNotification("Please provide a description", "warning");
      return;
    }

    try {
      const response = await fetch("/api/complaints/add_with_location", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          detection_type: "pothole",
          description: `User reported: ${description} (Severity: ${severity})`,
          latitude: reportLat,
          longitude: reportLng,
          confidence: 1.0,
          image_path: null,
        }),
      });

      const data = await response.json();

      if (data.status === "success") {
        showNotification("Report submitted successfully", "success");
        reportModal.hide();
        toggleReportMode();
        loadAllDetections();
      } else {
        showNotification("Failed to submit report", "danger");
      }
    } catch (error) {
      console.error("Error submitting report:", error);
      showNotification("Error submitting report", "danger");
    }
  }

  async function loadAllDetections() {
    try {
      const response = await fetch("/api/complaints/all_with_location");
      const data = await response.json();

      let potholeCount = 0;
      let accidentCount = 0;

      if (!isGlobeMode) {
        markers.forEach((m) => m.setMap(null));
        markers = [];
      } else if (window.MapUtils) {
        window.MapUtils.clearMarkers();
      }

      const tableBody = document.getElementById("detections-table");
      tableBody.innerHTML = "";

      if (data.complaints && data.complaints.length > 0) {
        data.complaints.forEach((complaint) => {
          if (complaint.latitude && complaint.longitude) {
            const isPothole = complaint.detection_type === "pothole";

            if (isPothole) potholeCount++;
            else accidentCount++;

            // Add to Map
            if (isGlobeMode && window.MapUtils) {
              window.MapUtils.addMarker(
                complaint.latitude,
                complaint.longitude,
                complaint.detection_type.toUpperCase(),
                null,
                `Confidence: ${(complaint.confidence * 100).toFixed(1)}%`
              );
            } else if (googleMap) {
              const color = isPothole ? "#f59e0b" : "#ef4444";
              const marker = new google.maps.Marker({
                position: { lat: complaint.latitude, lng: complaint.longitude },
                map: googleMap,
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 8,
                  fillColor: color,
                  fillOpacity: 0.9,
                  strokeColor: "white",
                  strokeWeight: 2,
                },
                title: complaint.detection_type.toUpperCase(),
              });

              // Store detection type on marker for filtering/counting
              marker.detectionType = complaint.detection_type;

              const infoWindow = new google.maps.InfoWindow({
                content: `
                                    <div style="padding:8px;">
                                        <h6 class="mb-1 fw-bold">${complaint.detection_type.toUpperCase()}</h6>
                                        <small class="text-muted">Confidence: ${(
                                          complaint.confidence * 100
                                        ).toFixed(1)}%</small><br>
                                        <small class="text-muted">${
                                          complaint.timestamp
                                        }</small>
                                    </div>
                                `,
              });

              marker.addListener("click", () =>
                infoWindow.open(googleMap, marker)
              );
              markers.push(marker);
            }

            // Add to table
            const row = document.createElement("tr");
            row.innerHTML = `
                            <td><span class="badge bg-${
                              isPothole ? "warning" : "danger"
                            } rounded-pill">${
              complaint.detection_type
            }</span></td>
                            <td class="small text-truncate" style="max-width: 150px;">${
                              complaint.address ||
                              `${complaint.latitude.toFixed(
                                4
                              )}, ${complaint.longitude.toFixed(4)}`
                            }</td>
                            <td class="small text-muted">${
                              complaint.timestamp
                            }</td>
                            <td><div class="progress" style="height: 6px;"><div class="progress-bar bg-${
                              isPothole ? "warning" : "danger"
                            }" style="width: ${
              complaint.confidence * 100
            }%"></div></div></td>
                            <td><button class="btn btn-sm btn-outline-light" onclick="focusOnLocation(${
                              complaint.latitude
                            }, ${
              complaint.longitude
            })"><i class="fas fa-eye"></i></button></td>
                        `;
            tableBody.appendChild(row);
          }
        });
      } else {
        tableBody.innerHTML =
          '<tr><td colspan="5" class="text-center py-4 text-muted">No detections found</td></tr>';
      }

      document.getElementById("pothole-count").textContent = potholeCount;
      document.getElementById("accident-count").textContent = accidentCount;
    } catch (error) {
      console.error("Error loading detections:", error);
    }
  }

  function focusOnLocation(lat, lng) {
    if (isGlobeMode && window.MapUtils) {
      window.MapUtils.flyToLocation(lat, lng, 17);
    } else if (googleMap) {
      googleMap.panTo({ lat, lng });
      googleMap.setZoom(17);
    }
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  async function showCurrentLocation() {
    if (!navigator.geolocation) {
      showNotification("Geolocation not supported", "warning");
      return;
    }

    showNotification("Getting location...", "info");

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude: lat, longitude: lng } = pos.coords;
        focusOnLocation(lat, lng);

        new google.maps.Marker({
          position: { lat, lng },
          map: googleMap,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: "#4f46e5",
            fillOpacity: 1,
            strokeColor: "white",
            strokeWeight: 3,
          },
          animation: google.maps.Animation.DROP,
        });

        showNotification("Location found", "success");
      },
      () => {
        showNotification("Location access denied", "danger");
      }
    );
  }

  async function searchAddress() {
    const address = document.getElementById("addressSearch").value;
    if (!address) return;

    try {
      const response = await fetch("/api/geocode", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address }),
      });
      const data = await response.json();

      if (data.lat && data.lng) {
        focusOnLocation(data.lat, data.lng);
        new google.maps.Marker({
          position: { lat: data.lat, lng: data.lng },
          map: googleMap,
          animation: google.maps.Animation.DROP,
        });
      } else {
        showNotification("Location not found", "warning");
      }
    } catch (e) {
      showNotification("Search failed", "danger");
    }
  }

  async function findNearbyHospitals() {
    if (!navigator.geolocation) {
      showNotification("Geolocation not supported by browser", "warning");
      return;
    }

    showNotification("Getting your location...", "info");

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        try {
          showNotification("Searching for nearby hospitals...", "info");
          const response = await fetch("/api/nearby_hospitals", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              radius: 5000,
            }),
          });
          const data = await response.json();

          if (data.error) {
            showNotification("Error: " + data.error, "danger");
            return;
          }

          if (data.hospitals?.length > 0) {
            // Center map on user location
            googleMap.panTo({
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
            });
            googleMap.setZoom(14);

            // Add user location marker
            new google.maps.Marker({
              position: { lat: pos.coords.latitude, lng: pos.coords.longitude },
              map: googleMap,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: "#4f46e5",
                fillOpacity: 1,
                strokeColor: "white",
                strokeWeight: 3,
              },
              title: "Your Location",
            });

            // Add hospital markers
            data.hospitals.forEach((h) => {
              const hospitalMarker = new google.maps.Marker({
                position: { lat: h.lat, lng: h.lng },
                map: googleMap,
                title: h.name,
                icon: {
                  url: "https://maps.google.com/mapfiles/kml/shapes/hospitals.png",
                  scaledSize: new google.maps.Size(32, 32),
                },
              });

              const infoWindow = new google.maps.InfoWindow({
                content: `
                  <div style="padding:8px;">
                    <h6 class="mb-1 fw-bold">${h.name}</h6>
                    <small class="text-muted">${
                      h.address || "Hospital"
                    }</small><br>
                    ${h.rating ? `<small>Rating: ⭐ ${h.rating}</small>` : ""}
                  </div>
                `,
              });

              hospitalMarker.addListener("click", () =>
                infoWindow.open(googleMap, hospitalMarker)
              );
            });

            showNotification(
              `Found ${data.hospitals.length} hospitals nearby`,
              "success"
            );
          } else {
            showNotification("No hospitals found within 5km radius", "info");
          }
        } catch (e) {
          console.error("Hospital search error:", e);
          showNotification("Failed to find hospitals: " + e.message, "danger");
        }
      },
      (error) => {
        let msg = "Location access denied";
        if (error.code === 2) msg = "Position unavailable";
        if (error.code === 3) msg = "Location request timed out";
        showNotification(msg + ". Please enable location services.", "warning");
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  }

  function toggleTerrainHeatmap() {
    if (!googleMap) return;
    const btn = document.getElementById("heatmap-toggle");

    if (heatmapLayer) {
      heatmapLayer.setMap(null);
      heatmapLayer = null;
      btn.classList.remove("btn-danger", "text-white");
      btn.classList.add("btn-light");
      return;
    }

    fetch("/api/terrain/heatmap")
      .then((res) => res.json())
      .then((data) => {
        if (!data.heatmap_data?.length) {
          showNotification("No risk data available", "warning");
          return;
        }

        const heatmapData = data.heatmap_data.map((p) => ({
          location: new google.maps.LatLng(p.lat, p.lng),
          weight: p.risk,
        }));

        heatmapLayer = new google.maps.visualization.HeatmapLayer({
          data: heatmapData,
          map: googleMap,
          radius: 30,
        });

        btn.classList.remove("btn-light");
        btn.classList.add("btn-danger", "text-white");
        showNotification("Risk map loaded", "success");
      });
  }

  async function generateDemoData() {
    if (!confirm("Generate demo data?")) return;

    try {
      const res = await fetch("/api/demo/generate", { method: "POST" });
      const data = await res.json();
      if (data.status === "success") {
        showNotification(
          `Generated ${data.detections_generated} detections`,
          "success"
        );
        loadAllDetections();
      }
    } catch (e) {
      showNotification("Failed to generate data", "danger");
    }
  }

  async function analyzeTerrainGEE() {
    if (!googleMap && !window.cesiumViewer) return;

    const btn = document.getElementById("gee-analyze");
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Analyzing...';

    try {
      // Get center coordinates
      let lat, lng;
      if (isGlobeMode && window.cesiumViewer) {
        const center = window.cesiumViewer.camera.positionCartographic;
        lat = Cesium.Math.toDegrees(center.latitude);
        lng = Cesium.Math.toDegrees(center.longitude);
      } else if (googleMap) {
        const center = googleMap.getCenter();
        lat = center.lat();
        lng = center.lng();
      }

      const response = await fetch("/api/terrain/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat, lng }),
      });

      const data = await response.json();

      if (data.error) throw new Error(data.error);

      // Show results
      const content = `
            <div class="text-start">
                <h6 class="fw-bold mb-2">Terrain Analysis (GEE)</h6>
                <div class="small">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Elevation:</span>
                        <span class="fw-bold">${data.elevation}m</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Slope:</span>
                        <span class="fw-bold">${data.slope}°</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Terrain:</span>
                        <span class="fw-bold text-primary">${data.terrain_type
                          .replace("_", " ")
                          .toUpperCase()}</span>
                    </div>
                    <div class="d-flex justify-content-between border-top pt-1 mt-1">
                        <span>Risk Score:</span>
                        <span class="fw-bold ${
                          data.pothole_risk_score > 50
                            ? "text-danger"
                            : "text-success"
                        }">${data.pothole_risk_score}/100</span>
                    </div>
                    <div class="mt-2 text-muted" style="font-size: 0.7rem">
                        Source: ${
                          data.analysis_method === "google_earth_engine"
                            ? "Google Earth Engine"
                            : "Estimated (Fallback)"
                        }
                    </div>
                </div>
            </div>
        `;

      // Create a popup/info window
      if (isGlobeMode && window.MapUtils) {
        window.MapUtils.addMarker(lat, lng, "Terrain Analysis", null, content);
        window.MapUtils.flyToLocation(lat, lng, 16);
      } else if (googleMap) {
        const infoWindow = new google.maps.InfoWindow({
          content: content,
          position: { lat, lng },
        });
        infoWindow.open(googleMap);
      }

      showNotification("Terrain analysis complete", "success");
    } catch (e) {
      console.error(e);
      showNotification("Analysis failed: " + e.message, "danger");
    } finally {
      btn.innerHTML = originalHtml;
    }
  }

  async function loadTerrainRiskData() {
    // Preload risk data if needed
  }

  window.initializeMap = initializeMap;

  // Debug: Log when scripts are ready
  console.log("Map Dashboard Initialized");
  console.log("Cesium available:", typeof Cesium !== "undefined");
  console.log("MapUtils available:", typeof window.MapUtils !== "undefined");

  // Fallback: If Google Maps API doesn't load within 10 seconds, show error
  setTimeout(() => {
    if (!mapInitialized && typeof google === "undefined") {
      handleMapError();
    }
  }, 10000);
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places,geometry,visualization&callback=initializeMap&loading=async"
  async
  defer
  onerror="handleMapError()"
></script>
{% endblock %}

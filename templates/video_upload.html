{% extends "base1.html" %} {% block content %}
<div class="container" style="max-width: 1400px; padding: 2rem">
  <div class="hero-section text-center mb-5">
    <h1 class="display-4 fw-bold gradient-text">Video Analysis</h1>
    <p class="lead text-secondary">
      Upload footage for AI-powered pothole and accident detection
    </p>
  </div>

  <div class="row g-4">
    <div class="col-lg-5">
      <div class="glass-card h-100">
        <div class="card-header-custom mb-4">
          <h4><i class="fas fa-cloud-upload-alt me-2"></i>Upload Video</h4>
        </div>

        <form id="uploadForm" enctype="multipart/form-data">
          <div class="upload-zone mb-4" id="dropZone">
            <i class="fas fa-file-video fa-3x mb-3 text-primary"></i>
            <p class="mb-2">Drag & drop video file here</p>
            <p class="text-muted small">or click to browse</p>
            <input
              type="file"
              id="videoFile"
              name="video"
              accept="video/*"
              required
              onchange="handleFileSelect(this)"
              class="file-input"
            />
          </div>
          <div id="fileInfo" class="mb-3 text-center" style="display: none">
            <span class="badge bg-primary-subtle text-primary p-2 rounded-pill">
              <i class="fas fa-film me-1"></i>
              <span id="fileName">filename.mp4</span>
            </span>
          </div>

          <div class="mb-4">
            <label for="detectionType" class="form-label fw-bold"
              >Detection Model</label
            >
            <select
              class="form-select custom-select"
              id="detectionType"
              name="detection_type"
              required
            >
              <option value="pothole">üï≥Ô∏è Pothole Detection</option>
              <option value="accident">üö® Accident Detection</option>
            </select>
          </div>

          <button
            type="submit"
            class="btn btn-primary w-100 btn-lg custom-btn"
            id="uploadBtn"
          >
            <i class="fas fa-play me-2"></i> Start Analysis
          </button>
        </form>

        <div
          id="processingControls"
          class="mt-4 pt-4 border-top border-light"
          style="display: none"
        >
          <h5 class="mb-3"><i class="fas fa-sliders-h me-2"></i>Controls</h5>
          <div class="d-grid gap-2 d-md-flex">
            <button
              id="pauseBtn"
              class="btn btn-warning flex-grow-1 custom-btn"
              onclick="togglePause()"
            >
              <i class="fas fa-pause me-2"></i> Pause
            </button>
            <button
              id="restartBtn"
              class="btn btn-info flex-grow-1 custom-btn text-white"
              onclick="restartProcessing()"
            >
              <i class="fas fa-redo me-2"></i> Restart
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="glass-card h-100 d-flex flex-column">
        <div
          class="card-header-custom mb-3 d-flex justify-content-between align-items-center"
        >
          <h4><i class="fas fa-eye me-2"></i>Live Analysis</h4>
          <span
            class="badge bg-danger pulse-badge"
            id="liveBadge"
            style="display: none"
            >LIVE</span
          >
        </div>

        <div class="video-wrapper flex-grow-1 mb-3">
          <div id="videoPlaceholder" class="video-placeholder">
            <div class="placeholder-content">
              <div class="icon-circle mb-3">
                <i class="fas fa-video"></i>
              </div>
              <h5>Ready to Analyze</h5>
              <p class="text-muted">
                Upload a video to see real-time detection results
              </p>
            </div>
          </div>
          <img
            id="videoStream"
            src=""
            class="img-fluid rounded-3 w-100"
            style="display: none"
            alt="Processed Video Stream"
          />
        </div>

        <div id="progressInfo" style="display: none">
          <div class="progress custom-progress mb-3">
            <div
              id="progressBar"
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              style="width: 0%"
            ></div>
          </div>

          <div class="row text-center g-2">
            <div class="col-4">
              <div class="stat-box">
                <small class="text-muted d-block">Progress</small>
                <span id="progressPercent" class="fw-bold text-primary"
                  >0%</span
                >
              </div>
            </div>
            <div class="col-4">
              <div class="stat-box">
                <small class="text-muted d-block">Frame</small>
                <span class="fw-bold"
                  ><span id="currentFrame">0</span> /
                  <span id="totalFrames">0</span></span
                >
              </div>
            </div>
            <div class="col-4">
              <div class="stat-box">
                <small class="text-muted d-block">Detections</small>
                <span id="detectionCount" class="fw-bold text-danger">0</span>
              </div>
            </div>
          </div>
        </div>

        <div id="results" class="mt-3" style="display: none">
          <div id="resultsContent"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .upload-zone {
    border: 2px dashed var(--border-color);
    border-radius: 16px;
    padding: 3rem 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.02);
    position: relative;
  }
  .upload-zone:hover {
    border-color: var(--accent-primary);
    background: rgba(79, 70, 229, 0.05);
  }
  .file-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }
  .video-wrapper {
    background: #000;
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
  }
  .placeholder-content {
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
  }
  .icon-circle {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    font-size: 2rem;
  }
  .stat-box {
    background: rgba(255, 255, 255, 0.05);
    padding: 0.5rem;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  .custom-progress {
    height: 8px;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.1);
  }
  .pulse-badge {
    animation: pulse-red 2s infinite;
  }
  @keyframes pulse-red {
    0% {
      box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
    }
  }
</style>

<script>
  let currentSessionId = null;
  let statusInterval = null;
  let isPaused = false;

  function handleFileSelect(input) {
    const file = input.files[0];
    if (file) {
      if (file.size > 50 * 1024 * 1024) {
        showNotification("File size exceeds 50MB limit.", "danger");
        input.value = "";
        return;
      }
      document.getElementById("fileName").textContent = file.name;
      document.getElementById("fileInfo").style.display = "block";
      document.querySelector(".upload-zone p").textContent = "File selected!";
    }
  }

  function updateProgress(
    status,
    currentFrame = 0,
    totalFrames = 0,
    detections = 0
  ) {
    const progressBar = document.getElementById("progressBar");
    const progressPercent = document.getElementById("progressPercent");
    const currentFrameElem = document.getElementById("currentFrame");
    const totalFramesElem = document.getElementById("totalFrames");
    const detectionCountElem = document.getElementById("detectionCount");

    let progress = 0;
    if (totalFrames > 0) {
      progress = Math.round((currentFrame / totalFrames) * 100);
    }

    progressBar.style.width = progress + "%";
    progressPercent.textContent = progress + "%";
    currentFrameElem.textContent = currentFrame;
    totalFramesElem.textContent = totalFrames;
    detectionCountElem.textContent = detections;

    if (status === "completed") {
      progressBar.classList.remove("progress-bar-animated");
      progressBar.classList.add("bg-success");
      document.getElementById("liveBadge").style.display = "none";
    } else if (isPaused) {
      progressBar.classList.add("bg-warning");
      progressBar.classList.remove("progress-bar-animated");
    } else {
      progressBar.classList.add("progress-bar-animated");
      progressBar.classList.remove("bg-success", "bg-warning");
      document.getElementById("liveBadge").style.display = "inline-block";
    }
  }

  function showVideoStream(sessionId) {
    const videoPlaceholder = document.getElementById("videoPlaceholder");
    const videoStream = document.getElementById("videoStream");
    const progressInfo = document.getElementById("progressInfo");
    const processingControls = document.getElementById("processingControls");

    videoPlaceholder.style.display = "none";
    videoStream.style.display = "block";
    progressInfo.style.display = "block";
    processingControls.style.display = "block";

    videoStream.src = `/video_stream/${sessionId}`;
    statusInterval = setInterval(() => updateProcessingStatus(sessionId), 1000);
  }

  function updateProcessingStatus(sessionId) {
    if (isPaused) return;

    fetch(`/get_processing_status/${sessionId}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "completed") {
          clearInterval(statusInterval);
          updateProgress(
            "completed",
            data.current_frame,
            data.total_frames,
            data.total_detections
          );
          showFinalResults(sessionId);
          showNotification("Analysis completed successfully!", "success");
        } else if (data.status === "processing") {
          updateProgress(
            "processing",
            data.current_frame,
            data.total_frames,
            data.total_detections
          );
        }
      })
      .catch((error) => console.error("Error:", error));
  }

  function showFinalResults(sessionId) {
    fetch(`/get_detection_results/${sessionId}`)
      .then((response) => response.json())
      .then((data) => {
        const resultsContent = document.getElementById("resultsContent");
        const resultsDiv = document.getElementById("results");

        let html = "";
        if (data.total_detections > 0) {
          html = `<div class="alert alert-success border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle fa-2x me-3"></i>
                            <div>
                                <h5 class="alert-heading mb-1">Analysis Complete</h5>
                                <p class="mb-0">Found <strong>${data.total_detections}</strong> potential issues.</p>
                            </div>
                        </div>
                    </div>`;
        } else {
          html = `<div class="alert alert-info border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle fa-2x me-3"></i>
                            <div>
                                <h5 class="alert-heading mb-1">Analysis Complete</h5>
                                <p class="mb-0">No issues detected in this video.</p>
                            </div>
                        </div>
                    </div>`;
        }

        resultsContent.innerHTML = html;
        resultsDiv.style.display = "block";
      });
  }

  function togglePause() {
    isPaused = !isPaused;
    const pauseBtn = document.getElementById("pauseBtn");

    if (isPaused) {
      pauseBtn.innerHTML = '<i class="fas fa-play me-2"></i> Resume';
      pauseBtn.className = "btn btn-success flex-grow-1 custom-btn";
    } else {
      pauseBtn.innerHTML = '<i class="fas fa-pause me-2"></i> Pause';
      pauseBtn.className = "btn btn-warning flex-grow-1 custom-btn";
    }
  }

  function restartProcessing() {
    if (currentSessionId) {
      const videoStream = document.getElementById("videoStream");
      videoStream.src = `/video_stream/${currentSessionId}`;
      updateProgress("processing", 0, 0, 0);
      isPaused = false;

      const pauseBtn = document.getElementById("pauseBtn");
      pauseBtn.innerHTML = '<i class="fas fa-pause me-2"></i> Pause';
      pauseBtn.className = "btn btn-warning flex-grow-1 custom-btn";

      document.getElementById("results").style.display = "none";
      showNotification("Restarting analysis...", "info");
    }
  }

  document
    .getElementById("uploadForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const uploadBtn = document.getElementById("uploadBtn");

      uploadBtn.disabled = true;
      uploadBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin me-2"></i> Uploading...';

      fetch("/upload_video", {
        method: "POST",
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            showNotification("Video uploaded! Starting analysis...", "success");
            currentSessionId = data.session_id;
            showVideoStream(currentSessionId);
          } else {
            throw new Error(data.error);
          }
        })
        .catch((error) => {
          showNotification(error.message, "danger");
        })
        .finally(() => {
          uploadBtn.disabled = false;
          uploadBtn.innerHTML =
            '<i class="fas fa-play me-2"></i> Start Analysis';
        });
    });

  window.addEventListener("beforeunload", function () {
    if (statusInterval) clearInterval(statusInterval);
  });
</script>
{% endblock %}

{% extends "base1.html" %} {% block content %}
<div class="container-fluid px-4 py-4">
  <div class="hero-section text-center mb-4">
    <h1 class="display-5 fw-bold gradient-text">Pothole Detection Map</h1>
    <p class="lead text-secondary">
      Real-time visualization of detected road hazards
    </p>
  </div>

  <div class="row g-4">
    <div class="col-lg-12">
      <div
        class="glass-card p-0 position-relative overflow-hidden"
        style="height: 70vh; min-height: 500px"
      >
        <!-- Map Controls Overlay -->
        <div
          class="map-controls-overlay d-flex flex-column gap-2"
          style="position: absolute; top: 1rem; left: 1rem; z-index: 10"
        >
          <!-- View Types -->
          <div
            class="btn-group shadow-sm bg-white bg-opacity-10 backdrop-blur rounded-pill p-1"
          >
            <button
              class="btn btn-sm btn-light rounded-pill active"
              id="btn-roadmap"
              onclick="switchMapType('roadmap')"
            >
              Road
            </button>
            <button
              class="btn btn-sm btn-light rounded-pill"
              id="btn-satellite"
              onclick="switchMapType('satellite')"
            >
              Sat
            </button>
            <button
              class="btn btn-sm btn-light rounded-pill"
              id="btn-terrain"
              onclick="switchMapType('terrain')"
            >
              Terrain
            </button>
            <button
              class="btn btn-sm btn-light rounded-pill"
              id="btn-hybrid"
              onclick="switchMapType('hybrid')"
            >
              Hybrid
            </button>
          </div>

          <!-- Layer Controls -->
          <div class="d-flex gap-2">
            <button
              class="btn btn-sm btn-light shadow-sm rounded-pill"
              id="btn-3d"
              onclick="toggle3D()"
            >
              <i class="fas fa-cube me-1"></i>3D
            </button>
          </div>
        </div>
        <div id="map" class="h-100 w-100"></div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="glass-card">
        <div class="card-header-custom mb-3">
          <h5><i class="fas fa-list me-2"></i>Detected Potholes</h5>
        </div>
        <div class="table-responsive">
          <table class="table table-hover custom-table align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Location</th>
                <th>Time</th>
                <th>Confidence</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for pothole in potholes %}
              <tr>
                <td>#{{ pothole[0] }}</td>
                <td>{{ pothole[4] }}</td>
                <td>{{ pothole[3] }}</td>
                <td>
                  <div class="progress" style="height: 6px">
                    <div
                      class="progress-bar bg-warning"
                      style="width: {{ pothole[2] * 100 }}%"
                    ></div>
                  </div>
                </td>
                <td>
                  <button
                    class="btn btn-sm btn-outline-light"
                    onclick="focusOnLocation({{ pothole[7] or 'null' }}, {{ pothole[8] or 'null' }})"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="5" class="text-center py-4 text-muted">
                  No potholes detected yet
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let googleMap;
  let markers = [];
  let is3D = false;

  function initializeMap() {
      const mapOptions = {
          center: { lat: 20.5937, lng: 78.9629 }, // Default to India center
          zoom: 5,
          mapTypeId: 'roadmap',
          mapTypeControl: false,
          streetViewControl: true,
          styles: [
              { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
              { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
              { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
              { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
              { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
              { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
          ]
      };

      googleMap = new google.maps.Map(document.getElementById("map"), mapOptions);

      // Add markers for potholes
      {% for pothole in potholes %}
          {% if pothole[7] and pothole[8] %}
          new google.maps.Marker({
              position: { lat: {{ pothole[7] }}, lng: {{ pothole[8] }} },
              map: googleMap,
              title: "Pothole #{{ pothole[0] }}",
              icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 8,
                  fillColor: "#f59e0b",
                  fillOpacity: 0.9,
                  strokeColor: "white",
                  strokeWeight: 2,
              }
          });
          {% endif %}
      {% endfor %}
  }

  function switchMapType(type) {
      if (!googleMap) return;
      googleMap.setMapTypeId(type);

      document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn-${type}`).classList.add('active');
  }

  function toggle3D() {
      if (!googleMap) return;
      const btn = document.getElementById('btn-3d');
      is3D = !is3D;

      if (is3D) {
          googleMap.setTilt(45);
          googleMap.setHeading(0);
          btn.classList.remove('btn-light');
          btn.classList.add('btn-success', 'text-white');
      } else {
          googleMap.setTilt(0);
          googleMap.setHeading(0);
          btn.classList.remove('btn-success', 'text-white');
          btn.classList.add('btn-light');
      }
  }

  function focusOnLocation(lat, lng) {
      if (lat && lng) {
          googleMap.panTo({ lat: lat, lng: lng });
          googleMap.setZoom(17);
          window.scrollTo({ top: 0, behavior: 'smooth' });
      }
  }

  window.initializeMap = initializeMap;
</script>
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQd8Alart7JSkAPGYJMNo-dgerTQ4v-W4&callback=initializeMap&loading=async"
  async
  defer
></script>
{% endblock %}

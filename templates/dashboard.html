{% extends "base1.html" %} {% block content %}
<div class="container-fluid px-4 py-4">
  <!-- Welcome Header -->
  <div class="hero-section text-center mb-5">
    <h1 class="display-4 fw-bold gradient-text mb-2">
      Welcome back, {{ username }}! ðŸ‘‹
    </h1>
    <p class="lead text-secondary">
      Your intelligent traffic management command center
    </p>
  </div>

  <!-- Quick Action Cards -->
  <div class="row g-4 mb-5">
    <div class="col-xl-3 col-md-6">
      <div class="glass-card h-100 hover-lift">
        <div class="d-flex align-items-center mb-3">
          <div
            class="icon-box bg-primary bg-opacity-10 text-primary rounded-3 p-3 me-3"
          >
            <i class="fas fa-map-marked-alt fa-2x"></i>
          </div>
          <h4 class="mb-0">Detection Map</h4>
        </div>
        <p class="text-muted mb-4">
          View all detections on interactive 2D maps or stunning 3D Globe
          visualization.
        </p>
        <a
          href="{{ url_for('map_dashboard') }}"
          class="btn btn-outline-primary w-100 custom-btn"
        >
          Open Map Dashboard <i class="fas fa-arrow-right ms-2"></i>
        </a>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="glass-card h-100 hover-lift">
        <div class="d-flex align-items-center mb-3">
          <div
            class="icon-box bg-danger bg-opacity-10 text-danger rounded-3 p-3 me-3"
          >
            <i class="fas fa-ambulance fa-2x"></i>
          </div>
          <h4 class="mb-0">Emergency</h4>
        </div>
        <p class="text-muted mb-4">
          Track ambulances and emergency vehicles with optimized OSRM routing.
        </p>
        <a
          href="{{ url_for('emergency_tracking') }}"
          class="btn btn-outline-danger w-100 custom-btn"
        >
          Track Vehicles <i class="fas fa-arrow-right ms-2"></i>
        </a>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="glass-card h-100 hover-lift">
        <div class="d-flex align-items-center mb-3">
          <div
            class="icon-box bg-info bg-opacity-10 text-info rounded-3 p-3 me-3"
          >
            <i class="fas fa-network-wired fa-2x"></i>
          </div>
          <h4 class="mb-0">Simulation</h4>
        </div>
        <p class="text-muted mb-4">
          Simulate traffic scenarios with AI-powered 6G V2X predictions.
        </p>
        <a
          href="{{ url_for('simulation') }}"
          class="btn btn-outline-info w-100 custom-btn"
        >
          Go to Simulation <i class="fas fa-arrow-right ms-2"></i>
        </a>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="glass-card h-100 hover-lift">
        <div class="d-flex align-items-center mb-3">
          <div
            class="icon-box bg-success bg-opacity-10 text-success rounded-3 p-3 me-3"
          >
            <i class="fas fa-robot fa-2x"></i>
          </div>
          <h4 class="mb-0">AI Detection</h4>
        </div>
        <p class="text-muted mb-4">
          Real-time pothole and accident detection using YOLOv5 computer vision.
        </p>
        <a
          href="{{ url_for('main') }}"
          class="btn btn-outline-success w-100 custom-btn"
        >
          Start Detection <i class="fas fa-arrow-right ms-2"></i>
        </a>
      </div>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="glass-card mb-5">
    <div class="card-header-custom mb-4">
      <h3><i class="fas fa-chart-bar me-2"></i>System Overview</h3>
    </div>
    <div class="row g-4">
      <div class="col-md-3 col-sm-6">
        <div class="stat-card text-center p-4 rounded-3 bg-white bg-opacity-5">
          <h2 class="display-4 fw-bold text-primary mb-0" id="total-detections">
            0
          </h2>
          <p class="text-muted fw-bold text-uppercase small">
            Active Detections
          </p>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stat-card text-center p-4 rounded-3 bg-white bg-opacity-5">
          <h2 class="display-4 fw-bold text-danger mb-0" id="emergency-count">
            0
          </h2>
          <p class="text-muted fw-bold text-uppercase small">
            Emergency Vehicles
          </p>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stat-card text-center p-4 rounded-3 bg-white bg-opacity-5">
          <h2 class="display-4 fw-bold text-success mb-0">
            <i class="fas fa-check-circle"></i>
          </h2>
          <p class="text-muted fw-bold text-uppercase small">System Status</p>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stat-card text-center p-4 rounded-3 bg-white bg-opacity-5">
          <h2 class="display-4 fw-bold text-info mb-0">
            <i class="fas fa-globe-asia"></i>
          </h2>
          <p class="text-muted fw-bold text-uppercase small">OpenStreetMap</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Configuration Card -->
    <div class="col-lg-6">
      <div class="glass-card h-100">
        <div class="card-header-custom mb-4">
          <h3><i class="fas fa-sliders-h me-2"></i>Simulation Config</h3>
        </div>
        <form id="simulation-config">
          <div class="mb-4">
            <label class="form-label fw-bold text-muted small"
              >VEHICLES PER ROAD</label
            >
            <input
              type="number"
              id="vehicle-count"
              class="form-control form-control-lg"
              min="1"
              max="20"
              value="5"
            />
          </div>

          <div class="mb-3">
            <div class="form-check form-switch custom-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="ai-prediction"
                checked
              />
              <label class="form-check-label" for="ai-prediction"
                >Enable AI Traffic Prediction</label
              >
            </div>
          </div>

          <div class="mb-4">
            <div class="form-check form-switch custom-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="emergency-priority"
                checked
              />
              <label class="form-check-label" for="emergency-priority"
                >Enable Emergency Vehicle Priority</label
              >
            </div>
          </div>

          <button
            type="button"
            id="apply-config"
            class="btn btn-primary w-100 custom-btn"
          >
            <i class="fas fa-save me-2"></i>Apply Configuration
          </button>
        </form>
      </div>
    </div>

    <!-- Quick Actions & Status -->
    <div class="col-lg-6">
      <div class="glass-card h-100">
        <div class="card-header-custom mb-4">
          <h3><i class="fas fa-bolt me-2"></i>Control Panel</h3>
        </div>
        <div class="d-grid gap-3 mb-4">
          <button id="start-sim" class="btn btn-success btn-lg custom-btn">
            <i class="fas fa-play me-2"></i>Start Simulation
          </button>
          <button id="stop-sim" class="btn btn-danger btn-lg custom-btn">
            <i class="fas fa-stop me-2"></i>Stop Simulation
          </button>
          <a
            href="{{ url_for('complaints') }}"
            class="btn btn-info btn-lg custom-btn text-white"
          >
            <i class="fas fa-clipboard-list me-2"></i>View All Complaints
          </a>
        </div>

        <div
          class="p-3 rounded-3 bg-white bg-opacity-5 text-center border border-white border-opacity-10"
        >
          <span class="text-muted me-2">Current Status:</span>
          <span id="sim-status" class="fw-bold text-secondary"
            >Not Running</span
          >
        </div>
      </div>
    </div>
  </div>

  <!-- Real-time Statistics -->
  <div class="glass-card mt-4">
    <div class="card-header-custom mb-4">
      <h3><i class="fas fa-chart-line me-2"></i>Real-time Telemetry</h3>
    </div>
    <div class="row g-4">
      <div class="col-md-3 col-6">
        <div
          class="p-3 rounded-3 bg-primary bg-opacity-10 border border-primary border-opacity-25 text-center"
        >
          <h3 class="fw-bold text-primary mb-0" id="active-vehicles">0</h3>
          <small class="text-muted text-uppercase">Active Vehicles</small>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div
          class="p-3 rounded-3 bg-success bg-opacity-10 border border-success border-opacity-25 text-center"
        >
          <h3 class="fw-bold text-success mb-0">
            <span id="avg-speed">0</span> <small class="fs-6">km/h</small>
          </h3>
          <small class="text-muted text-uppercase">Avg Speed</small>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div
          class="p-3 rounded-3 bg-info bg-opacity-10 border border-info border-opacity-25 text-center"
        >
          <h3 class="fw-bold text-info mb-0">
            <span id="avg-latency">0</span> <small class="fs-6">ms</small>
          </h3>
          <small class="text-muted text-uppercase">Latency</small>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div
          class="p-3 rounded-3 bg-warning bg-opacity-10 border border-warning border-opacity-25 text-center"
        >
          <h3 class="fw-bold text-warning mb-0">
            <span id="avg-signal">0</span> <small class="fs-6">dBm</small>
          </h3>
          <small class="text-muted text-uppercase">Signal Strength</small>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .hover-lift {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .hover-lift:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
  }
  .icon-box {
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .custom-switch .form-check-input {
    width: 3em;
    height: 1.5em;
    cursor: pointer;
  }
  .custom-switch .form-check-label {
    padding-left: 0.5rem;
    padding-top: 0.25rem;
    cursor: pointer;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    loadDetectionStats();
    loadEmergencyStats();

    document.getElementById("start-sim").addEventListener("click", function () {
      const btn = this;
      const originalHtml = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';

      fetch("/start_simulation")
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("sim-status").textContent = "Running âœ…";
          document.getElementById("sim-status").className =
            "fw-bold text-success";
          showNotification("Simulation started successfully", "success");
          updateStats();
        })
        .catch((error) => console.error("Error:", error))
        .finally(() => (btn.innerHTML = originalHtml));
    });

    document.getElementById("stop-sim").addEventListener("click", function () {
      const btn = this;
      const originalHtml = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Stopping...';

      fetch("/stop_simulation")
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("sim-status").textContent = "Stopped â¹ï¸";
          document.getElementById("sim-status").className =
            "fw-bold text-danger";
          showNotification("Simulation stopped", "info");
        })
        .catch((error) => console.error("Error:", error))
        .finally(() => (btn.innerHTML = originalHtml));
    });

    document
      .getElementById("apply-config")
      .addEventListener("click", function () {
        const btn = this;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

        const vehicleCount = document.getElementById("vehicle-count").value;
        const aiPrediction = document.getElementById("ai-prediction").checked;
        const emergencyPriority =
          document.getElementById("emergency-priority").checked;

        fetch("/update_config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            vehicle_count: parseInt(vehicleCount),
            ai_prediction: aiPrediction,
            emergency_priority: emergencyPriority,
          }),
        })
          .then((response) => response.json())
          .then((data) =>
            showNotification("Configuration updated successfully", "success")
          )
          .catch((error) => console.error("Error:", error))
          .finally(() => (btn.innerHTML = originalHtml));
      });

    function updateStats() {
      fetch("/get_simulation_stats")
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("active-vehicles").textContent =
            data.active_vehicles || 0;
          document.getElementById("avg-speed").textContent =
            data.avg_speed || 0;
          document.getElementById("avg-latency").textContent =
            data.avg_latency || 0;
          document.getElementById("avg-signal").textContent =
            data.avg_signal || 0;
        })
        .catch((error) => console.error("Error updating stats:", error));
    }

    async function loadDetectionStats() {
      try {
        const response = await fetch("/api/complaints/all_with_location");
        const data = await response.json();
        document.getElementById("total-detections").textContent =
          data.complaints ? data.complaints.length : 0;
      } catch (error) {
        console.error("Error loading detection stats:", error);
      }
    }

    async function loadEmergencyStats() {
      try {
        const response = await fetch("/api/emergency/all_active");
        const data = await response.json();
        document.getElementById("emergency-count").textContent = data.vehicles
          ? data.vehicles.length
          : 0;
      } catch (error) {
        console.error("Error loading emergency stats:", error);
      }
    }

    setInterval(updateStats, 5000);
    setInterval(loadDetectionStats, 10000);
    setInterval(loadEmergencyStats, 10000);
  });
</script>
{% endblock %}

{% extends "base1.html" %} {% block content %}
<div class="container" style="max-width: 1400px; padding: 2rem">
  <!-- Hero Section -->
  <div class="hero-section text-center mb-5">
    <h1 class="display-4 fw-bold gradient-text">Detection Reports</h1>
    <p class="lead text-secondary">
      Manage AI-detected issues and community reports
    </p>
  </div>

  <!-- Action Bar -->
  <div class="glass-card mb-4 p-4">
    <div
      class="d-flex flex-wrap justify-content-between align-items-center gap-3"
    >
      <div class="d-flex gap-3">
        <button
          class="btn btn-primary custom-btn"
          data-bs-toggle="modal"
          data-bs-target="#addComplaintModal"
        >
          <i class="fas fa-plus-circle me-2"></i>New Report
        </button>
        <a
          href="{{ url_for('map_dashboard') }}"
          class="btn btn-info custom-btn text-white"
        >
          <i class="fas fa-map-marked-alt me-2"></i>View Map
        </a>
      </div>
      <div class="stats-badge">
        <i class="fas fa-chart-pie me-2"></i>Total Reports: {{ complaints|length
        }}
      </div>
    </div>
  </div>

  {% if complaints %}
  <!-- Complaints Table -->
  <div class="glass-card p-0 overflow-hidden">
    <div class="table-responsive">
      <table class="table custom-table mb-0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Type</th>
            <th>Confidence</th>
            <th>Timestamp</th>
            <th>Location</th>
            <th>Description</th>
            <th>Evidence</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for complaint in complaints %}
          <tr>
            <td>
              <span class="fw-bold text-primary">#{{ complaint[0] }}</span>
            </td>
            <td>
              <span
                class="badge rounded-pill {{ 'bg-danger' if complaint[1] == 'accident' else 'bg-warning text-dark' }}"
              >
                <i
                  class="fas {{ 'fa-car-crash' if complaint[1] == 'accident' else 'fa-road' }} me-1"
                ></i>
                {{ complaint[1]|title }}
              </span>
            </td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div
                  class="progress flex-grow-1"
                  style="height: 6px; width: 60px"
                >
                  <div
                    class="progress-bar bg-success"
                    role="progressbar"
                    style="width: {{ complaint[2] * 100 }}%"
                  ></div>
                </div>
                <small class="fw-bold"
                  >{{ "%.0f"|format(complaint[2] * 100) }}%</small
                >
              </div>
            </td>
            <td class="text-muted small">
              <i class="far fa-clock me-1"></i>{{ complaint[3] }}
            </td>
            <td>
              <div
                class="d-flex align-items-center text-truncate"
                style="max-width: 200px"
              >
                <i class="fas fa-map-marker-alt text-danger me-2"></i>
                <span title="{{ complaint[9] or complaint[4] }}">
                  {% if complaint[9] %} {{ complaint[9] }} {% elif complaint[7]
                  and complaint[8] %} {{ "%.4f"|format(complaint[7]) }}, {{
                  "%.4f"|format(complaint[8]) }} {% else %} {{ complaint[4] or
                  'Unknown' }} {% endif %}
                </span>
              </div>
            </td>
            <td>
              <span
                class="text-muted text-truncate d-block"
                style="max-width: 200px"
                title="{{ complaint[5] }}"
              >
                {{ complaint[5] or 'Automatic Detection' }}
              </span>
            </td>
            <td>
              {% if complaint[6] %}
              <a
                href="{{ complaint[6] }}"
                target="_blank"
                class="btn btn-sm btn-outline-primary rounded-circle"
                title="View Image"
              >
                <i class="fas fa-image"></i>
              </a>
              {% else %}
              <span class="text-muted small">-</span>
              {% endif %}
            </td>
            <td>
              <div class="d-flex justify-content-center gap-2">
                {% if complaint[7] and complaint[8] %}
                <button
                  class="btn btn-sm btn-outline-info rounded-circle"
                  onclick="viewOnMap({{ complaint[7] }}, {{ complaint[8] }}, '{{ complaint[1] }}')"
                  title="Locate on Map"
                >
                  <i class="fas fa-crosshairs"></i>
                </button>
                {% endif %}
                <a
                  href="{{ url_for('delete_complaint', complaint_id=complaint[0]) }}"
                  class="btn btn-sm btn-outline-danger rounded-circle"
                  onclick="return confirm('Delete this report?')"
                  title="Delete Report"
                >
                  <i class="fas fa-trash-alt"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <!-- Empty State -->
  <div class="glass-card text-center py-5">
    <div class="mb-4">
      <div
        class="icon-circle mx-auto mb-3"
        style="width: 80px; height: 80px; font-size: 2rem"
      >
        <i class="fas fa-clipboard-check text-success"></i>
      </div>
      <h3>All Clear!</h3>
      <p class="text-muted">No detections or complaints found.</p>
    </div>
    <button
      class="btn btn-primary custom-btn"
      data-bs-toggle="modal"
      data-bs-target="#addComplaintModal"
    >
      <i class="fas fa-plus me-2"></i>Create First Report
    </button>
  </div>
  {% endif %}
</div>

<!-- Add Complaint Modal -->
<div class="modal fade" id="addComplaintModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card border-0">
      <div class="modal-header border-bottom border-light">
        <h5 class="modal-title fw-bold">
          <i class="fas fa-file-alt me-2"></i>New Report
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form id="complaintForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Issue Type</label>
            <div class="row g-2">
              <div class="col-6">
                <input
                  type="radio"
                  class="btn-check"
                  name="detection_type"
                  id="typeAccident"
                  value="accident"
                  required
                />
                <label class="btn btn-outline-danger w-100" for="typeAccident">
                  <i class="fas fa-car-crash me-2"></i>Accident
                </label>
              </div>
              <div class="col-6">
                <input
                  type="radio"
                  class="btn-check"
                  name="detection_type"
                  id="typePothole"
                  value="pothole"
                />
                <label
                  class="btn btn-outline-warning w-100 text-dark"
                  for="typePothole"
                >
                  <i class="fas fa-road me-2"></i>Pothole
                </label>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Description</label>
            <textarea
              name="description"
              id="description"
              class="form-control"
              rows="3"
              placeholder="Describe the issue details..."
              required
            ></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Location</label>
            <div class="input-group mb-2">
              <span class="input-group-text bg-transparent border-end-0">
                <i class="fas fa-map-marker-alt text-danger"></i>
              </span>
              <input
                type="text"
                id="locationAddress"
                class="form-control border-start-0"
                placeholder="Address or coordinates"
              />
              <button
                type="button"
                class="btn btn-outline-primary"
                onclick="useCurrentLocation()"
              >
                <i class="fas fa-crosshairs me-1"></i> GPS
              </button>
            </div>
            <input type="hidden" id="latitude" name="latitude" />
            <input type="hidden" id="longitude" name="longitude" />
            <div id="locationDisplay" class="small text-success fw-bold"></div>
          </div>
        </div>
        <div class="modal-footer border-top border-light">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary custom-btn">
            <i class="fas fa-save me-2"></i>Submit Report
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .stats-badge {
    background: rgba(79, 70, 229, 0.1);
    color: var(--accent-primary);
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-weight: 600;
    border: 1px solid rgba(79, 70, 229, 0.2);
  }
  .custom-table thead th {
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
  }
  .custom-table td {
    vertical-align: middle;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }
  .custom-table tr:hover td {
    background: rgba(255, 255, 255, 0.02);
  }
  .icon-circle {
    background: rgba(16, 185, 129, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>

<script>
  function viewOnMap(lat, lng, type) {
    sessionStorage.setItem("focusLat", lat);
    sessionStorage.setItem("focusLng", lng);
    sessionStorage.setItem("focusType", type);
    window.location.href = "{{ url_for('map_dashboard') }}";
  }

  async function useCurrentLocation() {
    const btn = event.currentTarget;
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    try {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            document.getElementById("latitude").value = lat;
            document.getElementById("longitude").value = lng;

            const response = await fetch("/api/reverse_geocode", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ lat: lat, lng: lng }),
            });

            const data = await response.json();
            document.getElementById("locationAddress").value =
              data.address || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById(
              "locationDisplay"
            ).innerHTML = `<i class="fas fa-check-circle me-1"></i>Location locked: ${lat.toFixed(
              4
            )}, ${lng.toFixed(4)}`;

            btn.innerHTML = originalContent;
            btn.disabled = false;
          },
          (error) => {
            alert("Error getting location: " + error.message);
            btn.innerHTML = originalContent;
            btn.disabled = false;
          }
        );
      } else {
        alert("Geolocation is not supported by this browser.");
        btn.innerHTML = originalContent;
        btn.disabled = false;
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Failed to get location");
      btn.innerHTML = originalContent;
      btn.disabled = false;
    }
  }

  document
    .getElementById("complaintForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
      submitBtn.disabled = true;

      const formData = {
        detection_type:
          document.querySelector('input[name="detection_type"]:checked')
            ?.value || "pothole",
        description: document.getElementById("description").value,
        latitude: parseFloat(document.getElementById("latitude").value) || null,
        longitude:
          parseFloat(document.getElementById("longitude").value) || null,
        confidence: 1.0,
      };

      try {
        const response = await fetch("/api/complaints/add_with_location", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData),
        });

        const data = await response.json();

        if (response.ok) {
          showNotification("Report submitted successfully!", "success");
          setTimeout(() => location.reload(), 1000);
        } else {
          showNotification("Error: " + data.error, "danger");
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      } catch (error) {
        console.error("Error:", error);
        showNotification("Failed to submit report", "danger");
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });
</script>
{% endblock %}
